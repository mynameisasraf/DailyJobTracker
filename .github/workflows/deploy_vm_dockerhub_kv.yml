name: Build image, fetch secrets from Key Vault, push to Docker Hub, and deploy to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-dailyjobtracker
  LOCATION: eastus
  VM_NAME: vm-docker-git
  ADMIN_USERNAME: asraf
  APP_PORT: 8080
  IMAGE_NAME: asraf/dailyjobtracker
  KEYVAULT_NAME: kv-dailyjobtracker
  DOCKERHUB_USER_SECRET: dockerhub-username
  DOCKERHUB_TOKEN_SECRET: dockerhub-token

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Docker Hub creds from Key Vault
        id: kv
        uses: azure/cli@v2
        with:
          inlineScript: |
            DOCKER_USER=$(az keyvault secret show --vault-name "$KEYVAULT_NAME" --name "$DOCKERHUB_USER_SECRET" --query value -o tsv)
            DOCKER_TOKEN=$(az keyvault secret show --vault-name "$KEYVAULT_NAME" --name "$DOCKERHUB_TOKEN_SECRET" --query value -o tsv)
            echo "dockerUser=$DOCKER_USER" >> $GITHUB_OUTPUT
            echo "dockerToken=$DOCKER_TOKEN" >> $GITHUB_OUTPUT

      - name: Docker Hub login
        run: echo "${{ steps.kv.outputs.dockerToken }}" | docker login -u "${{ steps.kv.outputs.dockerUser }}" --password-stdin

      - name: Build image
        run: docker build -t $IMAGE_NAME:${{ github.sha }} .

      - name: Tag latest
        run: docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest

      - name: Push images
        run: |
          docker push $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:latest

  provision-and-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write

    steps:
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group
        uses: azure/cli@v2
        with:
          inlineScript: |
            az group create -n $RESOURCE_GROUP -l $LOCATION

      - name: Create CentOS VM if missing
        uses: azure/cli@v2
        with:
          inlineScript: |
            if ! az vm show -g $RESOURCE_GROUP -n $VM_NAME >/dev/null 2>&1; then
              az vm create \
                -g $RESOURCE_GROUP \
                -n $VM_NAME \
                --image OpenLogic:CentOS:7.9:latest \
                --size Standard_B1s \
                --admin-username $ADMIN_USERNAME \
                --generate-ssh-keys \
                --public-ip-sku Standard
            fi

      - name: Open port 80 on NSG
        uses: azure/cli@v2
        with:
          inlineScript: |
            az vm open-port -g $RESOURCE_GROUP -n $VM_NAME --port 80 --priority 1001

      - name: Install Docker and run container
        uses: azure/cli@v2
        with:
          inlineScript: |
            az vm run-command invoke -g $RESOURCE_GROUP -n $VM_NAME --command-id RunShellScript --scripts '
              set -e
              # Install Docker CE
              sudo yum -y install yum-utils device-mapper-persistent-data lvm2
              sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
              sudo yum -y install docker-ce docker-ce-cli containerd.io || sudo yum -y install docker
              sudo systemctl enable --now docker

              # Stop old container
              sudo docker rm -f dailyjobtracker || true

              # Pull image from Docker Hub
              sudo docker pull '"$IMAGE_NAME:latest"'

              # Run container
              sudo docker run -d --name dailyjobtracker -p 80:'"$APP_PORT"' \
                -e ASPNETCORE_ENVIRONMENT=Production \
                '"$IMAGE_NAME:latest"'
            '

      - name: Output public IP
        uses: azure/cli@v2
        with:
          inlineScript: |
            IP=$(az vm list-ip-addresses -g $RESOURCE_GROUP -n $VM_NAME --query "[0].virtualMachine.network.publicIpAddresses[0].ipAddress" -o tsv)
            echo "App URL: http://$IP"
