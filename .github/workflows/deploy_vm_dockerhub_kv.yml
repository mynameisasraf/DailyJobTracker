name: Deploy custom image to VM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-dailyjobtracker
  LOCATION: eastus
  VM_NAME: vm-dailyjobtracker
  ADMIN_USERNAME: asraf
  APP_PORT: 8080
  IMAGE_NAME: ubuntu
  IMAGE_TAG: resolute-20251208

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group
        uses: azure/cli@v2
        with:
          inlineScript: |
            az group create -n $RESOURCE_GROUP -l $LOCATION

      - name: Create CentOS VM if missing
        uses: azure/cli@v2
        with:
          inlineScript: |
            if ! az vm show -g $RESOURCE_GROUP -n $VM_NAME >/dev/null 2>&1; then
              az vm create \
                -g $RESOURCE_GROUP \
                -n $VM_NAME \
                --image OpenLogic:CentOS:7.9:latest \
                --size Standard_B1s \
                --admin-username $ADMIN_USERNAME \
                --generate-ssh-keys \
                --public-ip-sku Standard
            fi

      - name: Open port 80 on NSG
        uses: azure/cli@v2
        with:
          inlineScript: |
            az vm open-port -g $RESOURCE_GROUP -n $VM_NAME --port 80 --priority 1001

      - name: Install Docker and run container
        uses: azure/cli@v2
        with:
          inlineScript: |
            az vm run-command invoke -g $RESOURCE_GROUP -n $VM_NAME --command-id RunShellScript --scripts '
              set -e
              # Install Docker CE
              sudo yum -y install yum-utils device-mapper-persistent-data lvm2
              sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
              sudo yum -y install docker-ce docker-ce-cli containerd.io || sudo yum -y install docker
              sudo systemctl enable --now docker

              # Stop old container
              sudo docker rm -f dailyjobtracker || true

              # Pull your chosen image
              sudo docker pull '"$IMAGE_NAME:$IMAGE_TAG"'

              # Run container
              sudo docker run -d --name dailyjobtracker -p 80:'"$APP_PORT"' \
                -e ASPNETCORE_ENVIRONMENT=Production \
                '"$IMAGE_NAME:$IMAGE_TAG"'
            '

      - name: Output public IP
        uses: azure/cli@v2
        with:
          inlineScript: |
            IP=$(az vm list-ip-addresses -g $RESOURCE_GROUP -n $VM_NAME --query "[0].virtualMachine.network.publicIpAddresses[0].ipAddress" -o tsv)
            echo "App URL: http://$IP"
