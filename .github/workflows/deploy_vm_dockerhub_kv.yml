name: Build and Deploy ASP.NET to Azure VMSS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-dailyjobtrackerNew
  LOCATION: westus3
  VMSS_NAME: vmss-dailyjobtracker
  ADMIN_USERNAME: asraf
  APP_PORT: 80
  IMAGE_NAME: mynameisasrafali/dailyjobtracker
  IMAGE_TAG: latest
  KEYVAULT_NAME: kv-dailyjobtracker   # replace with your actual Key Vault name
  SECRET_DOCKER_USERNAME: dockerhub-username
  SECRET_DOCKER_TOKEN: dockerhub-token

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch Docker Hub credentials from Key Vault
        id: kv
        uses: azure/cli@v2
        with:
          inlineScript: |
            USERNAME=$(az keyvault secret show --vault-name $KEYVAULT_NAME --name $SECRET_DOCKER_USERNAME --query value -o tsv)
            TOKEN=$(az keyvault secret show --vault-name $KEYVAULT_NAME --name $SECRET_DOCKER_TOKEN --query value -o tsv)
            echo "dockerhub_username=$USERNAME" >> $GITHUB_OUTPUT
            echo "dockerhub_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ steps.kv.outputs.dockerhub_username }}
          password: ${{ steps.kv.outputs.dockerhub_token }}

      - name: Build and push ASP.NET image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG

  provision-and-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
    steps:
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group
        uses: azure/cli@v2
        with:
          inlineScript: |
            az group create -n $RESOURCE_GROUP -l $LOCATION

      - name: Create VMSS if missing
        uses: azure/cli@v2
        with:
          inlineScript: |
            if ! az vmss show -g $RESOURCE_GROUP -n $VMSS_NAME >/dev/null 2>&1; then
              az vmss create \
                -g $RESOURCE_GROUP \
                -n $VMSS_NAME \
                --image Ubuntu2204 \
                --instance-count 2 \
                --vm-sku Standard_D2ls_v5 \
                --admin-username $ADMIN_USERNAME \
                --generate-ssh-keys \
                --upgrade-policy-mode automatic \
                --lb lb-dailyjobtracker \
                --backend-pool-name backendPool \
                --nat-pool-name natPool
            fi

      - name: Install Docker and run ASP.NET container on VMSS
        uses: azure/cli@v2
        with:
          inlineScript: |
            az vmss run-command invoke \
              -g $RESOURCE_GROUP \
              -n $VMSS_NAME \
              --command-id RunShellScript \
              --scripts '
                set -e
                sudo apt-get update
                sudo apt-get install -y docker.io
                sudo systemctl enable --now docker

                sudo docker rm -f dailyjobtracker || true
                sudo docker pull '"$IMAGE_NAME:$IMAGE_TAG"'
                sudo docker run -d --name dailyjobtracker -p 80:80 \
                  -e ASPNETCORE_ENVIRONMENT=Production \
                  '"$IMAGE_NAME:$IMAGE_TAG"'
              '

      - name: Output VMSS public IP
        uses: azure/cli@v2
        with:
          inlineScript: |
            IP=$(az network public-ip list -g $RESOURCE_GROUP --query "[0].ipAddress" -o tsv)
            echo "App URL: http://$IP"
